name: Deploy to Google Cloud
'on':
    push:
        branches:
            - master
jobs:
    setup-build-publish-deploy:
        name: Setup, Build, Publish, and Deploy
        runs-on: ubuntu-latest
        steps:
        - name: Checkout
          uses: actions/checkout@v2

        # Setup gcloud CLI
        - id: 'auth'
          uses: 'google-github-actions/auth@v1'
          with:
            credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

        - name: 'Set up Cloud SDK'
          uses: 'google-github-actions/setup-gcloud@v1'

        # Configure Docker with Credentials
        - name: Configure Docker
          run: |
              gcloud auth configure-docker

        # Build the Docker image
        - name: Build & Publish
          uses: docker/build-push-action@v2
          with:
            context: .
            push: ${{ github.event.base_ref =='refs/heads/master' && github.ref_type == 'tag' && !startsWith(github.ref, 'refs/tags/v0.')}}
            tags: ${{ steps.metadata.outputs.tags }}
            labels: ${{ steps.metadata.outputs.labels }}

        # Deploy the Docker image to the GKE cluster

